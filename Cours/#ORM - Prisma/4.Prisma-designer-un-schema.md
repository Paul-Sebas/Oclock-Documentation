# Savoir designer un schÃ©ma Prisma

Savoir **designer un schÃ©ma propre avant dâ€™Ã©crire la moindre ligne de code**, câ€™est exactement ce que Prisma cherche Ã  tâ€™apprendre (volontairement ou non).

On va raisonner **comme un architecte de donnÃ©es**, pas comme un â€œcodeur dâ€™ORMâ€.

---

## ğŸ§  Designer un schÃ©ma Prisma propre avant de coder

ğŸ“˜ Docs de rÃ©fÃ©rence (quâ€™on va appliquer, pas rÃ©citer) :

- <https://www.prisma.io/docs/orm/prisma-schema/overview>
- <https://www.prisma.io/docs/orm/prisma-schema/relations>
- <https://www.prisma.io/docs/orm/overview/databases/postgresql>

---

## ğŸ¯ Objectif mental

> Le schÃ©ma Prisma nâ€™est pas du code
>
> ğŸ‘‰ câ€™est une modÃ©lisation de ton domaine mÃ©tier

Si ton schÃ©ma est bon :

- le Prisma Client devient Ã©vident
- ton API Express devient simple
- tes bugs diminuent drastiquement

---

## 1. Etape 1 - Partir du mÃ©tier, pas de la technique

### âŒ Mauvaise approche

> Â« Je vais crÃ©er un User, un Post, et on verra aprÃ¨s Â»

### âœ… Bonne approche

Pose-toi ces questions en **franÃ§ais** :

- Quelles sont les **entitÃ©s mÃ©tier** ?

- Quâ€™est-ce qui **existe indÃ©pendamment** ?

- Quâ€™est-ce qui **dÃ©pend de quoi** ?

### Exemple : blog simple

En langage humain :

- Un utilisateur peut Ã©crire des articles
- Un article appartient Ã  un utilisateur
- Un article peut avoir des tags
- Un utilisateur peut exister sans article

ğŸ‘‰ Tu viens dÃ©jÃ  de dÃ©finir des relations et cardinalitÃ©s.

---

## Etape 2 - Lister les entitÃ©s (sans relations)

Commence **Ã  plat**, sans lien entre elles.

```txt
User
Post
Tag
```

Puis dÃ©finis **leur identitÃ© minimale**.

```prisma
model User {
  id Int @id @default(autoincrement())
}

model Post {
  id Int @id @default(autoincrement())
}

model Tag {
  id Int @id @default(autoincrement())
}
```

### ğŸ§  RÃ¨gle

> Toute entitÃ© a une **clÃ© primaire simple et stable**

---

## Etape 3 - Ajouter les attributs mÃ©tier

Uniquement ce qui **dÃ©crit l'entitÃ©**, pas les relations.

```prisma
model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  name  String?
}

model Post {
  id      Int    @id @default(autoincrement())
  title   String
  content String?
}

model Tag {
  id   Int    @id @default(autoincrement())
  name String @unique
}
```

### ğŸš« Ã€ ce stade

- pas de `userId`
- pas de relations
- pas de `@relation`

---

## Etape 4 - DÃ©finir les relation en franÃ§ais

Avant d'Ã©crire Prisma, Ã©cris Ã§a :

```txt
User 1 â€”â€” N Post
Post N â€”â€” N Tag
```

Et prÃ©cise :

- obligatoire ou optionnel ?
- qui dÃ©pend de qui ?
- suppression en cascade ou non ?

---

## Etape 5 - ImplÃ©menter les relations UNE PAR UNE

âš ï¸ Erreur classique : tout faire dâ€™un coup.

### 5.1 Relation User --> Post (1-N)

#### Raisonnement

- Un Post doit avoir un User
- Un User peut avoir 0 ou plusieurs Posts
- Le Post dÃ©pend du User

#### ImplÃ©mentation

```prisma
model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  name  String?

  posts Post[]
}

model Post {
  id      Int    @id @default(autoincrement())
  title   String
  content String?

  userId Int
  user   User @relation(fields: [userId], references: [id])
}
```

### ğŸ§  ClÃ© mentale

> la clÃ© Ã©trangÃ¨re va du cÃ´tÃ© dÃ©pendant

---

### 5.2 Relation Post <--> Tag (N-N)

#### Question Ã  se poser

> Ai-je besoin de stocker des infos sur la relation ?

- âŒ Non â†’ relation implicite

- âœ… Oui â†’ relation explicite

#### Version simple (implicite)

```prisma
model Post {
  id    Int    @id @default(autoincrement())
  title String

  tags Tag[]
}

model Tag {
  id    Int    @id @default(autoincrement())
  name  String @unique

  posts Post[]
}
```

ğŸ‘‰ Prisma gÃ¨re la table de jointure.

---

## Etape 6 - GÃ©rer l'optionnalitÃ© AVANT les migrations

Pose-toi systÃ©matiquement :

> Est ce que cette relation peut ne pas exister ?

### Exemple : Post sans auteur (draft)

```prisma
userId Int?
user   User?
```

ğŸ§  Optionnel = cohÃ©rent partout.

---

## Etape 7 - DÃ©finir les contraintes mÃ©tier

Pas tout, juste l'essentiel.

### Exemples utiles

```prisma
email String @unique
name  String @db.VarChar(100)
```

ğŸ‘‰ Les contraintes Ã©vitent les bugs **avant le code**.

---

## 8. Lire le schÃ©ma comme une phrase

Exercice simple mais puissant :

```prisma
model Post {
  userId Int
  user   User
}
```

Lis Ã  voix haute :

> â€œUn Post appartient Ã  un User et ne peut pas exister sans luiâ€

Si la phrase sonne faux â†’ schÃ©ma faux.

---

## 9. Tester mentalement avec Prisma Client

Avant d'Ã©crire du code, imagine :

```ts
prisma.post.create({
  data: {
    title: "...",
    user: { connect: { id: 1 } }
  }
})
```

Si tu ne sais pas quoi Ã©crire naturellement â†’ schÃ©ma mal pensÃ©.

---

## 10. Checklist finale avant `prisma migrate`

Avant toute migration, vÃ©rifie :

âœ… chaque relation a une FK claire

âœ… optionnel cohÃ©rent

âœ… 1-1 â†’ `@unique`

âœ… noms explicites (`userId`, pas `uId`)

âœ… pas de relation â€œfuture hypothÃ©tiqueâ€

---

## ğŸ§  RÃ¨gle dâ€™or Prisma

> Un bon schÃ©ma rend le code Ã©vident
>
> Un mauvais schÃ©ma rend le code pÃ©nible
---
