# Connexion Ã  MongoDB depuis Express

Comme pour PostgreSQL, on peut connecter notre app Express Ã  une base de donnÃ©es MongoDB. Pour cela il faut utiliser le _driver_ appropriÃ© et explorer la documentation pour comprendre la syntaxe de ce package.

- Un package : [mongodb](https://www.npmjs.com/package/mongodb)
- [La documentation](https://www.mongodb.com/docs/drivers/node/current/)

## 1. Installer les dÃ©pendances

En premier on installe le package `mongodb` :

```bash
npm install mongodb
```

> Ce package permet Ã  ton app Node.js de parler avec MongoDB.

---

## 2. Se connecter Ã  MongoDB

On crÃ©e un fichier `config/db.js` pour gÃ©rer la connexion :

```js
import { MongoClient } from "mongodb";

const uri = "mongodb://localhost:27017"; // Adresse par dÃ©faut de MongoDB
export const client = new MongoClient(uri);

// Fonction appelÃ©e au dÃ©marrage de l'app pour Ã©tablir la connexion
export async function initDb() {
  try {
    await client.connect();
    console.log("âœ… ConnectÃ© Ã  MongoDB");
  } catch (err) {
    console.error("âŒ Erreur de connexion Ã  MongoDB :", err);
  }
}
```

> On crÃ©e une fonction `initDb()` qui ouvre la connexion Ã  la base.  
> Elle sera appelÃ©e une seule fois au dÃ©marrage de lâ€™app.

---

## 3. SÃ©lectionner une base et une collection

Une fois connectÃ©, tu peux te positionner sur une base MongoDB :

```js
const db = client.db("mongotests"); // crÃ©e ou ouvre la base "mongotests"
```

Puis, tu pourras manipuler une collection :

```js
const usersCollection = db.collection("users");
```

---

## 4. Exemple dâ€™API Express avec MongoDB

Voici les routes de base pour manipuler des utilisateurs dans une collection MongoDB :

```js
import express from "express";
import { client, initDb } from "./config/db.js";
import { ObjectId } from "mongodb";

const app = express();
app.use(express.json());

// Connexion Ã  la base
initDb();
const db = client.db("mongotests");

// CrÃ©er un utilisateur
app.post("/users", async (req, res) => {
  const { email, password } = req.body;
  const result = await db.collection("users").insertOne({ email, password });
  res.status(201).json(result);
});

// RÃ©cupÃ©rer tous les utilisateurs
app.get("/users", async (req, res) => {
  const users = await db.collection("users").find().toArray();
  res.status(200).json(users);
});

// RÃ©cupÃ©rer un utilisateur par ID
app.get("/users/:id", async (req, res) => {
  const user = await db.collection("users").findOne({
    _id: new ObjectId(req.params.id),
  });
  res.status(200).json(user);
});

// Modifier un utilisateur
app.put("/users/:id", async (req, res) => {
  const { email, password } = req.body;
  const result = await db.collection("users").updateOne(
    { _id: new ObjectId(req.params.id) },
    { $set: { email, password } }
  );
  res.status(200).json(result);
});

// Supprimer un utilisateur
app.delete("/users/:id", async (req, res) => {
  const result = await db.collection("users").deleteOne({
    _id: new ObjectId(req.params.id),
  });
  res.status(200).json(result);
});

app.listen(3000, () => {
  console.log("ðŸš€ Serveur lancÃ© sur http://localhost:3000");
});
```

---

## 5. Valider les donnÃ©es avec Joi (optionnel mais recommandÃ©)

MongoDB accepte nâ€™importe quelles donnÃ©es. Pour Ã©viter des erreurs ou des entrÃ©es incohÃ©rentes, tu peux valider les donnÃ©es envoyÃ©es par lâ€™utilisateur avec la librairie [Joi](https://joi.dev).

### Installation

```bash
npm install joi
```

### Exemple d'utilisation

```js
import Joi from "joi";

// DÃ©claration dâ€™un schÃ©ma de validation
const schema = Joi.object({
  email: Joi.string().email({ tlds: { allow: ["com", "fr"] } }),
  password: Joi.string().pattern(new RegExp("^[a-zA-Z0-9]{3,30}$")),
});

// VÃ©rification avant d'insÃ©rer en base
try {
  await schema.validateAsync({ email, password });
} catch (err) {
  return res.status(403).json(err);
}
```

---

## 6. Organisation du projet

Tu peux organiser ton projet comme ceci :

```sh
myapp/
â”œâ”€â”€ app.js               # Point d'entrÃ©e principal
â”œâ”€â”€ package.json
â”œâ”€â”€ config/
â”‚   â””â”€â”€ db.js            # Connexion Ã  MongoDB
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ index.js         # Fichiers de routes Express
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ userController.js (optionnel)  # Logique mÃ©tier
```

## âœ… RÃ©capitulatif

| Ã‰tape                           | Ã€ faire                                          |
| ------------------------------- | ------------------------------------------------ |
| Installer `mongodb`             | `npm install mongodb`                            |
| Ã‰tablir la connexion            | CrÃ©er une fonction `initDb()` avec `MongoClient` |
| Choisir une base et collection  | `client.db("nom").collection("nom")`             |
| CrÃ©er des routes CRUD           | `insertOne`, `find`, `updateOne`, `deleteOne`    |
| (Optionnel) Valider les donnÃ©es | Utiliser `Joi` pour valider `email`, `password`  |

Tu es maintenant prÃªt Ã  construire une API Express avec MongoDB ! ðŸŽ¯